[B<!DOCTYPE html>
<meta charset="utf-8">
<script src="http://d3js.org/d3.v2.min.js?2.9.3"></script>
<style>

.link {
  stroke: #aaa;
}

.node text {
stroke:#333;
cursos:pointer;
}

.node circle{
stroke:#fff;
stroke-width:3px;
fill:#555;
}

</style>
<body>
<script>

var width = 960,
    height = 500

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

var force = d3.layout.force()
    .gravity(.05)
    .distance(100)
    .charge(-100)
    .size([width, height]);

function parseLinkGraphJson(lg_data) {
  var nodes = [];
  var links = [];
  var node_list = [];
  // var i=0;
  Object.keys(lg_data.graph).forEach(node_id => {
    nodes.push({"name": node_id, "group": 1});
    node_list.push(node_id);
  });

  Object.entries(lg_data.graph).forEach(entry => {
    var node_id = entry[0];
    var neighbors = entry[1];
    neighbors.forEach(neighbor => {
      links.push(
        {"source": node_list.indexOf(node_id), "target": node_list.indexOf(neighbor), "weight": 4}
      );
    });
  });

  Object.entries(lg_data.data).forEach(entry => {
    var node_id = entry[0];
    var data = entry[1];
    var ip = data.ip;
    data.sensors.forEach(sensor_data => {
      var sensor_name = `${sensor_data.device} (${sensor_data._id})`;
      if(node_list.indexOf(sensor_name) < 0) {
      	nodes.push({"name": sensor_name, "group": 2});
      	node_list.push(sensor_name);
      }
      links.push(
        { "source": node_list.indexOf(node_id), 
          "target": node_list.indexOf(sensor_name), 
          "weight": 1
        }
      );
    });
  });

  return {"nodes": nodes, "links": links};
}

function color(d) {
 if(d.group === 1)
	return "#3366cc";
 else return "#7CFC00";
}

function radius(d) {
  if(d.group === 1)
	return "10";
  else
	return "8";
}

d3.json("http://{{ ip_address }}:5000/execute/5c596f351fc2ea9777dfd470", function(linkGraph) {
  const json = parseLinkGraphJson(linkGraph);
  console.log(json);
  force
      .nodes(json.nodes)
      .links(json.links)
      .start();

  var link = svg.selectAll(".link")
      .data(json.links)
    .enter().append("line")
      .attr("class", "link")
      .attr("stroke", "#999")
      .attr("stroke-opacity", 0.6)
    .style("stroke-width", function(d) { return Math.sqrt(d.weight); });

  var node = svg.selectAll(".node")
      .data(json.nodes)
    .enter().append("g")
      .attr("class", "node")
      .call(force.drag);

  node.append("circle")
      .attr("r",radius)
      .style("stroke", "white")
      .style("stroke-width","1.5")
      .style("fill",color);

  node.append("text")
      .attr("dx", 12)
      .attr("dy", ".35em")
      .text(function(d) { return d.name });

  force.on("tick", function() {
    link.attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });

    node.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
  });

  console.log(node);
});

</script>

